!function t(e,r,n){function a(i,s){if(!r[i]){if(!e[i]){var l="function"==typeof require&&require;if(!s&&l)return l(i,!0);if(o)return o(i,!0);var u=new Error("Cannot find module '"+i+"'");throw u.code="MODULE_NOT_FOUND",u}var c=r[i]={exports:{}};e[i][0].call(c.exports,function(t){var r=e[i][1][t];return a(r?r:t)},c,c.exports,t,e,r,n)}return r[i].exports}for(var o="function"==typeof require&&require,i=0;i<n.length;i++)a(n[i]);return a}({1:[function(t,e,r){"use strict";var n=t("./metro-map"),a=function(){return new L.TileLayer("https://{s}.tiles.mapbox.com/v3/inker.km1inchd/{z}/{x}/{y}.png",{minZoom:9,id:"inker.km1inchd",detectRetina:!0,bounds:null,attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://mapbox.com">Mapbox</a>'})}(),o=function(){return new L.TileLayer("http://openmapsurfer.uni-hd.de/tiles/roads/x={x}&y={y}&z={z}",{minZoom:0,maxZoom:20,attribution:'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'})}();console.log("hi!");var i=new n("map-container",function(t){return 15>t?a:o});i.getGraphAndFillMap()},{"./metro-map":2}],2:[function(t,e,r){"use strict";var n=window.L,a=t("./svg"),o=t("./util"),i=function(){function t(t,e){var r=11;this.tileLayersForZoom=e,this._tileLayer=e(11),this.map=new n.Map(t,{inertia:!1}).addLayer(this._tileLayer).setView(new n.LatLng(60,30),r).addControl(new n.Control.Scale({imperial:!1})),console.log("map should be created by now"),this.overlay=document.getElementById("overlay"),this.overlay.id="overlay",this.overlay.style.fill="white",this.overlay.style.zIndex="10",this.addListeners()}return t.prototype.addListeners=function(){var t=this,e=this.map.getPanes().mapPane,r=void 0;this.map.on("move",function(){return t.overlay.style.transform=e.style.transform}),this.map.on("moveend",function(){return t.exTranslate=o.parseTransform(t.overlay.style.transform)}),this.map.on("zoomstart",function(){r=t.map.getZoom(),t.overlay.style.opacity="0.5"}),this.map.on("zoomend",function(){var e=t.tileLayersForZoom(t.map.getZoom());t.tileLayersForZoom(r)!=e&&(t.tileLayer=e),t.redrawNetwork(),t.overlay.style.opacity=null})},t.prototype.refillSVG=function(){for(var t=this,e=void 0;e=this.overlay.firstChild;)this.overlay.removeChild(e);["paths","transfers","station-circles","dummy-circles"].forEach(function(e){var r=a.createSVGElement("g");r.id=e,t.overlay.appendChild(r)});var r=document.getElementById("transfers");r.classList.add("transfer")},t.prototype.getGraphAndFillMap=function(){var t=this,e=new XMLHttpRequest;e.onreadystatechange=function(){if(4===e.readyState){if(200!==e.status)return console.error("couldn't fetch the graph:\n"+e.status+": "+e.statusText);t.graph=JSON.parse(e.responseText),t.extendBounds(),t.map.setView(t.bounds.getCenter()),t.map.once("moveend",function(e){return t.redrawNetwork()})}},e.open("GET","json/graph.json",!0),e.setRequestHeader("X-Requested-With","XMLHttpRequest"),e.send()},t.prototype.extendBounds=function(){var t=this,e=this.graph.platforms[0].location;this.bounds=new n.LatLngBounds(e,e),this.graph.platforms.forEach(function(e){return t.bounds.extend(e.location)})},Object.defineProperty(t.prototype,"tileLayer",{get:function(){return this._tileLayer},set:function(t){var e=this;this.map.addLayer(t);var r=this._tileLayer;t.once("load",function(){return e.map.removeLayer(r)}),this._tileLayer=t},enumerable:!0,configurable:!0}),t.prototype.showPlate=function(t){var e=t.target,r=e.dataset,n=document.getElementById(r.platformId||r.stationId),o=a.makePlate(n),i=e.parentNode,s=i.parentNode;s.insertBefore(o,i)},t.prototype.posOnSVG=function(t,e){var r=this.map.latLngToContainerPoint(e);return r.subtract(t.min)},t.prototype.redrawNetwork=function(){var t=this,e=this;this.refillSVG(),console.log(o.getUserLanguage()),console.log(this.graph.platforms.length);var r=this.map.getZoom(),i=this.bounds.getNorthWest(),s=this.bounds.getSouthEast(),l=new n.Bounds(this.map.latLngToContainerPoint(i),this.map.latLngToContainerPoint(s));console.log("bounds: "+l.min),console.log(this.overlay.style.transform);var u=o.parseTransform(this.overlay.style.transform);this.overlay.style.left=(l.min.x-u.x).toString()+"px",this.overlay.style.top=(l.min.y-u.y).toString()+"px";var c=l.getSize();this.overlay.style.width=c.x+"px",this.overlay.style.height=c.y+"px";var p=new Array(this.graph.platforms.length),d=document.createDocumentFragment(),m=document.getElementById("station-circles"),h=document.getElementById("dummy-circles");10>r||(12>r?!function(){{var n=.5*(r-7),o=1.25*n,i=.4*o;document.getElementById("transfers")}t.graph.stations.forEach(function(t,r){var n=e.map.latLngToContainerPoint(t.location),s=n.subtract(l.min),u=a.makeCircle(s,o);a.convertToStation(u,"s-"+r,t,i),m.appendChild(u);var c=a.makeCircle(s,2*o);c.classList.add("invisible-circle"),c.dataset.stationId=u.id,h.appendChild(c),c.onmouseover=e.showPlate,c.onmouseout=function(t){return e.overlay.removeChild(document.getElementById("plate"))}})}():!function(){var i=.5*(r-7),s=.4*i,u=new Set,c=document.getElementById("transfers");t.graph.stations.forEach(function(t,r){var n=o.findCircle(e.graph,t),m=[];if(t.platforms.forEach(function(t){var c=e.graph.platforms[t],g=e.posOnSVG(l,c.location),f=a.makeCircle(g,i);a.convertToStation(f,"p-"+t.toString(),c,s),f.dataset.station=r.toString();var y=a.makeCircle(g,2*i);if(y.classList.add("invisible-circle"),y.dataset.platformId=f.id,d.appendChild(f),h.appendChild(y),y.onmouseover=e.showPlate,y.onmouseout=function(t){return e.overlay.removeChild(document.getElementById("plate"))},2===c.spans.length){for(var v=[g,g],x=[0,0],b=0;2>b;++b){var S=e.graph.spans[c.spans[b]],w=S.source===t?S.target:S.source,L=e.graph.platforms[w],C=e.posOnSVG(l,L.location);x[b]=o.getSegmentLength(g,C),v[b]=g.add(C).divideBy(2)}var E=v[1].subtract(v[0]).multiplyBy(x[0]/(x[0]+x[1])),A=v[0].add(E),B=g.subtract(A);p[t]=[v[0].add(B),v[1].add(B)]}n&&n.indexOf(c)>-1&&(m.push(g),u.add(t))}),n){var g=o.getCircumcenter(m),f=o.getSegmentLength(g,m[0]),y=a.makeCircle(g,f);y.classList.add("transfer"),y.style.strokeWidth=s.toString(),y.style.opacity="0.5",c.appendChild(y)}document.getElementById("station-circles").appendChild(d)});for(var m=0;m<t.graph.spans.length;++m){var g=t.graph.spans[m],f=t.graph.platforms[g.source],y=t.graph.platforms[g.target],v=f,x=y;if(2===f.spans.length){var b=m==f.spans[0]?f.spans[1]:f.spans[0],S=t.graph.spans[b],w=S.source==g.source?S.target:S.source;v=t.graph.platforms[w]}if(2===y.spans.length){var b=m==y.spans[0]?y.spans[1]:y.spans[0],S=t.graph.spans[b],L=S.source==g.target?S.target:S.source;x=t.graph.platforms[L]}{[v,f,y,x].map(function(t){return e.map.latLngToContainerPoint(t.location)}).map(function(t){return new n.Point(t.x-l.min.x,t.y-l.min.y)})}}t.graph.transfers.forEach(function(t){if(!u.has(t.source)||!u.has(t.target)){var r=e.graph.platforms[t.source],n=e.graph.platforms[t.target],o=e.posOnSVG(l,r.location),i=e.posOnSVG(l,n.location),c=a.createSVGElement("line");c.setAttribute("x1",o.x.toString()),c.setAttribute("y1",o.y.toString()),c.setAttribute("x2",i.x.toString()),c.setAttribute("y2",i.y.toString()),c.classList.add("transfer"),c.style.strokeWidth=s.toString(),c.style.opacity="0.5",document.getElementById("transfers").appendChild(c)}})}())},t}();e.exports=i},{"./svg":3,"./util":4}],3:[function(t,e,r){"use strict";function n(t,e){var r=i("circle");return r.setAttribute("r",e.toString()),r.setAttribute("cy",t.y.toString()),r.setAttribute("cx",t.x.toString()),r}function a(t,e,r,n){t.id=e,t.classList.add("station-circle"),t.style.strokeWidth=n.toString(),t.dataset.lat=r.location.lat.toString(),t.dataset.lng=r.location.lng.toString(),t.dataset.ru=r.name,t.dataset.fi=r.altName}function o(t){if(4!==t.length)throw new Error("there should be 4 points");var e=i("path"),r=t.reduce(function(t,e,r){return""+t+(1===r?"C":" ")+e.x+","+e.y},"M");return e.setAttribute("d",r),e}function i(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function s(t){var e=u.createSVGElement("g"),r=u.createSVGElement("line"),n=new l.Point(Number(t.getAttribute("cx")),Number(t.getAttribute("cy"))),a=(Number(t.getAttribute("r")),new l.Point(4,8)),o=new l.Bounds(n,n.subtract(a));r.setAttribute("x1",o.min.x.toString()),r.setAttribute("y1",o.min.y.toString()),r.setAttribute("x2",o.max.x.toString()),r.setAttribute("y2",o.max.y.toString()),r.classList.add("plate-pole");var i=t.dataset.ru,s=t.dataset.fi,p=s?Math.max(i.length,s.length):i.length,d=u.createSVGElement("rect"),m=12,h=new l.Point(10+6*p,s?18+m:18);d.setAttribute("width",h.x.toString()),d.setAttribute("height",h.y.toString());var g=o.min.subtract(h);d.setAttribute("x",g.x.toString()),d.setAttribute("y",g.y.toString()),d.classList.add("plate-box");var f=u.createSVGElement("text"),y=u.createSVGElement("tspan"),v=n.subtract(new l.Point(3,h.y-12)).subtract(o.getSize());y.setAttribute("x",v.x.toString()),y.setAttribute("y",v.y.toString());var x=y.cloneNode();return x.setAttribute("y",(v.y+m).toString()),"fi"===c.getUserLanguage()?(y.textContent=s,x.textContent=i):(y.textContent=i,x.textContent=s),f.setAttribute("fill","black"),f.appendChild(y),f.appendChild(x),f.classList.add("plate-text"),e.appendChild(d),e.appendChild(r),e.appendChild(f),e.id="plate",e}var l=window.L,u=t("./svg"),c=t("./util");r.makeCircle=n,r.convertToStation=a,r.makeCubicBezier=o,r.createSVGElement=i,r.makePlate=s},{"./svg":3,"./util":4}],4:[function(t,e,r){"use strict";function n(){var t=(navigator.userLanguage||navigator.language).substr(0,2).toLowerCase();return["ru","fi"].indexOf(t)>-1?t:"en"}function a(t){var e=t.match(/translate3d\((-?\d+)px,\s?(-?\d+)px,\s?(-?\d+)px\)/i);return e?new l.Point(Number(e[1]),Number(e[2])):new l.Point(0,0)}function o(t,e){var r=[];return e.platforms.forEach(function(e){return r.push(t.platforms[e])}),3===r.length&&r.every(function(t){return 2===t.transfers.length})?r:null}function i(t){if(3!=t.length)throw new Error("must have 3 vertices");console.log(t[1]);var e=t[1].subtract(t[0]),r=t[2].subtract(t[0]);return new l.Point(r.y*(e.x*e.x+e.y*e.y)-e.y*(r.x*r.x+r.y*r.y),e.x*(r.x*r.x+r.y*r.y)-r.x*(e.x*e.x+e.y*e.y)).divideBy(2*(e.x*r.y-e.y*r.x)).add(t[0])}function s(t,e){var r=e.subtract(t);return Math.sqrt(r.x*r.x+r.y*r.y)}var l=window.L;r.getUserLanguage=n,r.parseTransform=a,r.findCircle=o,r.getCircumcenter=i,r.getSegmentLength=s},{}]},{},[1]);