webpackJsonp([1],{255:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=s(3),o=s(29),n=s(354),a=s(254),i=s(28),d=s(42),l=s(259),c=s(45),m=s(25),{intersection:u,tryGetFromMap:f,tryGetKeyFromBiMap:h}=m.collections;class p extends a.default{constructor(e){super(e)}makeMap(){const e=e=>super[e];return r.__awaiter(this,void 0,void 0,function*(){yield e("makeMap").call(this),new l.MapEditor(this.config.detailedZoom).addTo(this)})}addMapListeners(){super.addMapListeners();const e=e=>{const t=e;return i.default.outerEdgeBindings.getKey(t)||i.default.innerEdgeBindings.getKey(t)},t=e=>h(i.default.dummyBindings,e),{map:s,contextMenu:r}=this;this.subscribe("platformrename",e=>{const s=t(e.relatedTarget),r=m.svg.getElementOffset(e.relatedTarget),o=m.getPlatformNames(s);this.tooltip.show(r,o),l.platformRenameDialog(s)}),this.subscribe("platformmovestart",e=>{this.tooltip.disabled=!0}),this.subscribe("platformmove",e=>{t(e.relatedTarget).location=m.mouseToLatLng(s,e)}),this.subscribe("platformmoveend",e=>{const s=t(e.relatedTarget);this.tooltip.disabled=!1,this.tooltip.show(m.svg.getElementOffset(e.relatedTarget),m.getPlatformNames(s))}),this.subscribe("platformadd",t=>{const{detail:r}=t,o=m.mouseToLatLng(s,r),n=new c.Platform(d.tr`New station`,o,{});if(this.network.platforms.push(n),void 0!==r.relatedTarget){const t=e(r.relatedTarget),s=t.source===n?"target":"source",o=new c.Span(n,t[s],t.routes);t[s]=n,this.network.spans.push(o)}this.overlay.extendBounds(o),this.resetNetwork(JSON.parse(this.network.toJSON()))}),this.subscribe("platformdelete",e=>{const s=t(e.relatedTarget);this.network.deletePlatform(s),this.redrawNetwork()}),this.subscribe("spanroutechange",t=>{if(void 0===t.relatedTarget)return;const s=e(t.relatedTarget),r=l.askRoutes(this.network,new Set(s.routes));s.routes=Array.from(r),this.resetNetwork(JSON.parse(this.network.toJSON()))}),this.subscribe("spaninvert",t=>{void 0!==t.relatedTarget&&(e(t.relatedTarget).invert(),this.resetNetwork(JSON.parse(this.network.toJSON())))}),this.subscribe("spanend",e=>{const t=h(i.default.dummyBindings,e.detail.source),s=h(i.default.dummyBindings,e.detail.target);r.removeItem("spanend");const o=t.passingRoutes(),n=s.passingRoutes(),a=o.size,d=n.size,m=a>0&&0===d?1===a?o:l.askRoutes(this.network,o):d>0&&0===a?1===d?n:l.askRoutes(this.network,n):l.askRoutes(this.network,u(o,n));this.network.spans.push(new c.Span(t,s,Array.from(m))),this.resetNetwork(JSON.parse(this.network.toJSON()))}),this.subscribe("spandelete",t=>{if(void 0===t.relatedTarget)return;const s=e(t.relatedTarget);o.default(this.network.spans,s),this.resetNetwork(JSON.parse(this.network.toJSON()))}),this.subscribe("transferend",e=>{const t=h(i.default.dummyBindings,e.detail.source),s=h(i.default.dummyBindings,e.detail.target);console.log(t,s),r.removeItem("transferend"),this.network.transfers.push(new c.Transfer(t,s)),this.resetNetwork(JSON.parse(this.network.toJSON()))}),this.subscribe("transferdelete",e=>{if(void 0===e.relatedTarget)return;const t=e.relatedTarget,s=i.default.outerEdgeBindings.getKey(t)||i.default.innerEdgeBindings.getKey(t);o.default(this.network.transfers,s),this.resetNetwork(JSON.parse(this.network.toJSON()))}),this.subscribe("editmapstart",e=>{s.getZoom()<this.config.detailedZoom&&s.setZoom(this.config.detailedZoom);const t=e=>{const t=e.parentElement;if(!t)return!1;const s=t.id;return"paths-outer"===s||"paths-inner"===s};r.insertItem("platformaddclick","New station",e=>!t(e));const o=e=>{const t=e.parentElement;return!!t&&"dummy-circles"===t.id};r.insertItem("platformrename","Rename station",o),r.insertItem("platformdelete","Delete station",o),r.insertItem("spanstart","Span from here",o),r.insertItem("transferstart","Transfer from here",o),r.insertItem("spanroutechange","Change route",t),r.insertItem("spaninvert","Invert span",t),r.insertItem("platformaddtolineclick","Add station to line",t),r.insertItem("spandelete","Delete span",t),r.insertItem("transferdelete","Delete transfer",e=>{const t=e.parentElement;if(!t)return!1;const s=t.id;return"transfers-outer"===s||"transfers-inner"===s})}),this.subscribe("editmapend",e=>{r.removeItem("platformaddclick"),r.removeItem("platformrename"),r.removeItem("platformdelete"),r.removeItem("spanstart"),r.removeItem("transferstart"),r.removeItem("platformaddtolineclick"),r.removeItem("spanroutechange"),r.removeItem("spandelete"),r.removeItem("transferdelete")}),this.subscribe("mapsave",e=>{const t=this.network.toJSON();l.gitHubDialog(t).catch(e=>{console.error(e),n.downloadText("graph.json",t)})})}redrawNetwork(){super.redrawNetwork(),this.addBindings()}addBindings(){const{platforms:e}=this.network,{platformBindings:t,dummyBindings:s}=i.default;for(const r of e)this.platformToModel(r,[f(t,r),f(s,r)])}platformToModel(e,t){const s=e.location;Object.defineProperty(e,"location",{get:()=>e._location,set:s=>{e._location=s;const r=this.map.getZoom()<this.config.detailedZoom?e.station.getCenter():s,o=this.overlay.latLngToOverlayPoint(r);for(const e of t)e.setAttribute("cx",o.x.toString()),e.setAttribute("cy",o.y.toString());this.whiskers.set(e,this.makeWhiskers(e)),this.platformsOnSVG.set(e,o);const n=new Set(e.spans);for(const t of e.spans){const s=t.other(e);this.whiskers.set(s,this.makeWhiskers(s));for(const e of s.spans)n.add(e)}for(const e of n){const t=[f(this.platformsOnSVG,e.source),f(f(this.whiskers,e.source),e),f(f(this.whiskers,e.target),e),f(this.platformsOnSVG,e.target)],s=f(i.default.outerEdgeBindings,e),r=i.default.innerEdgeBindings.get(e);m.svg.bezier.setPath(s,t),r&&m.svg.bezier.setPath(r,t)}for(const t of e.transfers)t[t.source===e?"source":"target"]=e}}),e._location=s}}t.default=p},354:function(e,t,s){"use strict";e.exports=s(355)},355:function(e,t,s){"use strict";function r(e,t){var s=document.createElement("a");s.href=t,s.download=e,s.click()}function o(e,t){var s=URL.createObjectURL(t);r(e,s),URL.revokeObjectURL(s)}t.downloadBlob=o,t.downloadText=function(e,t){o(e,new Blob([t],{type:"octet/stream"}))}}});